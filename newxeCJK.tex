\makeatletter
\ExplSyntaxOn

\tl_new:N \l_@@_CJK_fontfamily_tl

\cs_new:Npn \@@_tmp:w #1 ; #2 \q_stop
  {
    \tl_new:c { l_@@_CJK_ #1 family _tl }
    \exp_args:Nc \NewDocumentCommand { setCJK #2 font }
      { O{} m O{} }
      {
        \exp_args:Nc \setfontfamily { l_@@_CJK_ #1 family _tl }
          [ Script = CJK~Ideographic , ##1 ] {##2} [##3]
        \tex_ignorespaces:D
      }
    \exp_args:Nc \NewDocumentCommand { CJK #1 family }
      { }
      {
        \tl_set_eq:Nc \l_@@_CJK_fontfamily_tl
          { l_@@_CJK_ #1 family _tl }
      }
% For ltfssini.dtx 2020/01/11 v3.1f or later, until 2020/08/24 v3.2c
    \tl_put_right:co { @ #1 familyhook }
      { \cs:w CJK #1 family \cs_end: }
% For ltfssini.dtx 2020/08/24 v3.2c or later
%    \exp_args:Nno \AddToHook { #1 family }
%      { \cs:w CJK #1 family \cs_end: }
  }

\clist_map_inline:nn
  {
    rm ; main ,
    sf ; sans ,
    tt ; mono
  }
  { \@@_tmp:w #1 \q_stop }

\cs_set:Npn \@@_tmp:w #1 ; #2 \q_stop
  {
    \exp_args:Nc \NewDocumentCommand { #1 CJKfontfamily }
      { m O{} m O{} }
      {
        #2 ##1
          { }
          {
            \tl_set_eq:Nc \l_@@_CJK_fontfamily_tl
              { l_@@_CJK_ \cs_to_str:N ##1 _tl }
          }
        \tl_clear_new:c { l_@@_CJK_ \cs_to_str:N ##1 _tl }
        \exp_args:Nc \setfontfamily
          { l_@@_CJK_ \cs_to_str:N ##1 _tl }
          [ Script = CJK~Ideographic , ##2 ] {##3} [##4]
        \tex_ignorespaces:D
      }
    \exp_args:Nc \NewDocumentCommand { #1 CJKfontface }
      { m O{} m O{} }
      {
        \cs:w #1 CJKfontfamily \cs_end: ##1
          [
            ItalicFont    = { } ,
            BoldFont      = { } ,
            SmallCapsFont = { } ,
            ##2
          ] {##3} [##4]
      }
  }

\clist_map_inline:nn
  {
    new     ; \NewDocumentCommand     ,
    renew   ; \RenewDocumentCommand   ,
    provide ; \ProvideDocumentCommand ,
    set     ; \DeclareDocumentCommand
  }
  { \@@_tmp:w #1 \q_stop }

\newXeTeXintercharclass \g_@@_CJK_class
\newXeTeXintercharclass \g_@@_Closing_LeftHalf_class
\newXeTeXintercharclass \g_@@_Closing_MiddleHalf_class
\newXeTeXintercharclass \g_@@_Closing_Full_class
\newXeTeXintercharclass \g_@@_Opening_RightHalf_class
\newXeTeXintercharclass \g_@@_Opening_Full_class
\newXeTeXintercharclass \g_@@_non_CJK_Punct_class

% Manipulating inter-char token registers

\cs_new_eq:NN \@@_interchartoks_set:NNn
    \tex_XeTeXinterchartoks:D
\cs_new_protected:Npn \@@_interchartoks_set:nNn #1
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set:Nnn #1#2
  {
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #1
      \cs:w g_@@_ #2 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set:nnn #1#2
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #2 _class \cs_end:
  }

\cs_new_protected:Npn \@@_interchartoks_set_eq:NNNN #1#2
  {
    \tex_XeTeXinterchartoks:D #1 #2
    \tex_XeTeXinterchartoks:D
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:NNnN #1#2#3
  {
    \tex_XeTeXinterchartoks:D #1 #2
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #3 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:NNNn #1#2#3#4
  {
    \tex_XeTeXinterchartoks:D #1 #2
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #3
      \cs:w g_@@_ #4 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:NNnn #1#2#3#4
  {
    \tex_XeTeXinterchartoks:D #1 #2
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #3 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #4 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:nNNN #1#2
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \cs_end:
      #2
    \tex_XeTeXinterchartoks:D
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:nNnN #1#2#3
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \cs_end:
      #2
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #3 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:nNNn #1#2#3#4
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \cs_end:
      #2
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #3
      \cs:w g_@@_ #4 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:nNnn #1#2#3#4
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \cs_end:
      #2
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #3 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #4 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:NnNN #1#2
  {
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #1
      \cs:w g_@@_ #2 _class \cs_end:
    \tex_XeTeXinterchartoks:D
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:NnnN #1#2#3
  {
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #1
      \cs:w g_@@_ #2 _class \cs_end:
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #3 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:NnNn #1#2#3#4
  {
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #1
      \cs:w g_@@_ #2 _class \cs_end:
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #3
      \cs:w g_@@_ #4 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:Nnnn #1#2#3#4
  {
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #1
      \cs:w g_@@_ #2 _class \cs_end:
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #3 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #4 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:nnNN #1#2
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #2 _class \cs_end:
    \tex_XeTeXinterchartoks:D
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:nnnN #1#2#3
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #2 _class \cs_end:
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #3 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:nnNn #1#2#3#4
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #2 _class \cs_end:
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #3
      \cs:w g_@@_ #4 _class \cs_end:
  }
\cs_new_protected:Npn \@@_interchartoks_set_eq:nnnn #1#2#3#4
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #2 _class \cs_end:
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #3 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #4 _class \cs_end:
  }

\cs_new_protected:Npn \@@_interchartoks_clear:NN #1#2
  {
    \tex_XeTeXinterchartoks:D #1 #2 { }
  }
\cs_new_protected:Npn \@@_interchartoks_clear:nN #1#2
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \cs_end:
      #2
      { }
  }
\cs_new_protected:Npn \@@_interchartoks_clear:Nn #1#2
  {
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #1
      \cs:w g_@@_ #2 _class \cs_end:
      { }
  }
\cs_new_protected:Npn \@@_interchartoks_clear:nn #1#2
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #2 _class \cs_end:
      { }
  }

\cs_new_protected:Npn \@@_interchartoks_put_left:NNn #1#2
  {
    \exp_after:wN \@@_interchartoks_put_left_aux:NNw
      \exp_after:wN #1
      \exp_after:wN #2
      \exp_after:wN \q_nil
      \tex_the:D \tex_XeTeXinterchartoks:D #1 #2 \q_stop
  }
\cs_new_protected:Npn \@@_interchartoks_put_left:nNn #1#2
  {
    \exp_after:wN \@@_interchartoks_put_left_aux:NNw
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \exp_after:wN #2
      \exp_after:wN \q_nil
      \tex_the:D \tex_XeTeXinterchartoks:D
        \cs:w g_@@_ #1 _class \cs_end:
        #2
      \q_stop
  }
\cs_new_protected:Npn \@@_interchartoks_put_left:Nnn #1#2
  {
    \exp_after:wN \@@_interchartoks_put_left_aux:NNw
      \exp_after:wN #1
      \cs:w g_@@_ #2 _class \exp_after:wN \cs_end:
      \exp_after:wN \q_nil
      \tex_the:D \tex_XeTeXinterchartoks:D
        \exp_after:wN #1
        \cs:w g_@@_ #2 _class \cs_end:
      \q_stop
  }
\cs_new_protected:Npn \@@_interchartoks_put_left:nnn #1#2
  {
    \exp_after:wN \@@_interchartoks_put_left_aux:NNw
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #2 _class \exp_after:wN \cs_end:
      \exp_after:wN \q_nil
      \tex_the:D \tex_XeTeXinterchartoks:D
        \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
        \cs:w g_@@_ #2 _class \cs_end:
      \q_stop
  }
\cs_new_protected:Npn \@@_interchartoks_put_left_aux:NNw
  #1#2 #3 \q_stop #4
  {
    \tex_XeTeXinterchartoks:D #1 #2
      \exp_after:wN { \use_i:nn {#4} #3 }
  }

\cs_new_protected:Npn \@@_interchartoks_put_right:NNn #1#2#3
  {
    \tex_XeTeXinterchartoks:D #1 #2
      \exp_after:wN {
        \tex_the:D \tex_XeTeXinterchartoks:D #1 #2
        #3
      }
  }
\cs_new_protected:Npn \@@_interchartoks_put_right:nNn #1#2#3
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \cs_end:
      #2
      \exp_after:wN {
        \tex_the:D \tex_XeTeXinterchartoks:D
          \cs:w g_@@_ #1 _class \cs_end:
          #2
        #3
      }
  }
\cs_new_protected:Npn \@@_interchartoks_put_right:Nnn #1#2#3
  {
    \tex_XeTeXinterchartoks:D
      \exp_after:wN #1
      \cs:w g_@@_ #2 _class \cs_end:
      \exp_after:wN {
        \tex_the:D \tex_XeTeXinterchartoks:D
          \exp_after:wN #1
          \cs:w g_@@_ #2 _class \cs_end:
        #3
      }
  }
\cs_new_protected:Npn \@@_interchartoks_put_right:nnn #1#2#3
  {
    \tex_XeTeXinterchartoks:D
      \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
      \cs:w g_@@_ #2 _class \cs_end:
      \exp_after:wN {
        \tex_the:D \tex_XeTeXinterchartoks:D
          \cs:w g_@@_ #1 _class \exp_after:wN \cs_end:
          \cs:w g_@@_ #2 _class \cs_end:
        #3
      }
  }

\tl_new:N  \l_@@_CJKglue_tl
\tl_set:Nn \l_@@_CJKglue_tl { 0em plus 1em / 16 }

\tl_new:N  \l_@@_CJKecglue_tl
\tl_set:Nn \l_@@_CJKecglue_tl { 2em plus 1em minus 1em / 10 }

\fp_new:N \l_@@_punct_width_ratio_fp
\cs_new_protected:Npn \SetPunctWidthRatio #1
  {
    \fp_set:Nn \l_@@_punct_width_ratio_fp {#1}
  }

\fp_new:N    \l_@@_end_sentence_punct_width_ratio_fp
\clist_new:N \l_@@_end_sentence_punct_clist
\cs_new_protected:Npn \SetEndSentencePunctWidthRatio #1
  {
    \fp_set:Nn \l_@@_end_sentence_punct_width_ratio_fp {#1}
  }

\fp_new:N \l_@@_punct_min_width_ratio_fp
\fp_new:N \l_@@_punct_removable_width_ratio_fp
\cs_new_protected:Npn \SetPunctMinWidthRatio #1
  {
    \fp_set:Nn \l_@@_punct_min_width_ratio_fp {#1}
    \exp_args:NNx \fp_set:Nn
      \l_@@_punct_removable_width_ratio_fp
      { \fp_max:nn { 1 - #1 } \c_zero_fp }
  }

\fp_new:N \l_@@_mid_punct_min_width_ratio_fp
\fp_new:N \l_@@_mid_punct_removable_width_ratio_fp
\cs_new_protected:Npn \SetMiddlePunctMinWidthRatio #1
  {
    \fp_set:Nn \l_@@_mid_punct_min_width_ratio_fp {#1}
    \exp_args:NNx \fp_set:Nn
      \l_@@_mid_punct_removable_width_ratio_fp
      { \fp_max:nn { ( 1 - #1 ) / 2 } \c_zero_fp }
  }

\fp_new:N \l_@@_punct_kern_width_ratio_fp
\cs_new_protected:Npn \SetPunctKernWidthRatio #1
  {
    \exp_args:NNx \fp_set:Nn
      \l_@@_punct_kern_width_ratio_fp
      { \fp_abs:n {#1} }
  }

\cs_new_protected:Npn \quanjiaostyle
  {
    \SetPunctWidthRatio { 1 }
    \SetEndSentencePunctWidthRatio { 1 }
    \SetPunctMinWidthRatio { 0.5 }
    \SetMiddlePunctMinWidthRatio { 0.5 }
    \SetPunctKernWidthRatio { -0.5 }
  }
\quanjiaostyle
\cs_new_protected:Npn \banjiaostyle
  {
    \SetPunctWidthRatio { 0.5 }
    \SetEndSentencePunctWidthRatio { 0.5 }
    \SetPunctMinWidthRatio { 0.5 }
    \SetMiddlePunctMinWidthRatio { 0.5 }
    \SetPunctKernWidthRatio { -0.5 }
  }
\cs_new_protected:Npn \kaimingstyle
  {
    \SetPunctWidthRatio { 0.5 }
    \SetEndSentencePunctWidthRatio { 1 }
    \SetPunctMinWidthRatio { 0.5 }
    \SetMiddlePunctMinWidthRatio { 0.5 }
    \SetPunctKernWidthRatio { -0.5 }
  }
\cs_new_protected:Npn \plainstyle
  {
    \SetPunctWidthRatio { 1 }
    \SetEndSentencePunctWidthRatio { 1 }
    \SetPunctMinWidthRatio { 1 }
    \SetMiddlePunctMinWidthRatio { 1 }
    \SetPunctKernWidthRatio { 0 }
  }

\tl_new:N \l_@@_CJK_condensed_ratio_tl
\msg_new:nnnn { newxeCJK } { decimal-not-allowed }
  { The~expression~'#1'~must~be~converted~into~a~fraction. }
  {
    For~example,~if~you~want~'0.8',~
    then~you~should~write~'8/10'~or~'4/5'.
  }
\cs_new_protected:Npn \SetCJKCondensedRatio #1
  {
    \str_if_in:nnTF {#1} { . }
      {
        \msg_error:nnn { newxeCJK } { decimal-not-allowed } {#1}
      }
      {
        \tl_set:Nn \l_@@_CJK_condensed_ratio_tl {#1}
      }
  }
\SetCJKCondensedRatio { 1 }

\bool_new:N       \l_@@_enable_hanging_punct_bool
\bool_set_false:N \l_@@_enable_hanging_punct_bool
%\bool_set_true:N  \l_@@_enable_hanging_punct_bool
\clist_new:N      \l_@@_hangable_punct_clist

\clist_new:N \l_@@_keep_blank_punct_clist

\cs_new_protected:Npn \@@_nobreak:
  { \tex_penalty:D 10 000 ~ }

\cs_new_protected:Npn \@@_allowbreak:
  { \tex_penalty:D 0 ~ }

\cs_new_protected:Npn \@@_insert_CJKglue:
  { \skip_horizontal:n { \l_@@_CJKglue_tl } }

\cs_new_protected:Npn \@@_insert_nobreak_CJKglue:
  { \@@_nobreak: \skip_horizontal:n { \l_@@_CJKglue_tl } }

\cs_new_protected:Npn \@@_insert_CJKecglue:
  { \skip_horizontal:n { \l_@@_CJKecglue_tl } }

\cs_new_protected:Npn \@@_insert_nobreak_CJKecglue:
  { \@@_nobreak: \skip_horizontal:n { \l_@@_CJKecglue_tl } }

\cs_new_protected:Npn \@@_remove_blank:n #1
  {
    \tex_vrule:D
      height \c_zero_dim
      depth  \c_zero_dim
      width
        - \tex_dimexpr:D
            #1 * \l_@@_CJK_condensed_ratio_tl
          \tex_relax:D
      \scan_stop:
  }

\cs_new_protected:Npn \@@_remove_blank_add_glue:n #1
  {
    \@@_remove_blank:n {#1}
    \skip_horizontal:n
      { #1 * \l_@@_CJK_condensed_ratio_tl }
  }

\cs_new_protected:Npn \@@_add_shrinkable_glue:n #1
  {
    \skip_horizontal:n
      { #1 minus #1 * \l_@@_CJK_condensed_ratio_tl }
  }

\bool_new:N \l_@@_keep_current_punct_blank_bool
\bool_new:N \l_@@_hang_current_punct_bool
\fp_new:N   \l_@@_current_punct_width_ratio_fp

\cs_new_protected:Npn \@@_preprocess_closing_punct:nN #1#2
  {
    \bool_set_false:N \l_@@_keep_current_punct_blank_bool
    \@@_if_in_setup:Nnn
      \l_@@_keep_blank_punct_clist
      { `#2 }
      { \bool_set_true:N \l_@@_keep_current_punct_blank_bool }
    \bool_set_false:N \l_@@_hang_current_punct_bool
    \bool_if:NT \l_@@_enable_hanging_punct_bool
      {
        \@@_if_in_setup:Nnn
          \l_@@_hangable_punct_clist
          { `#2 }
          { \bool_set_true:N \l_@@_hang_current_punct_bool }
      }
    \fp_compare:nNnT
        \l_@@_current_punct_width_ratio_fp
      < \l_@@_end_sentence_punct_width_ratio_fp
      {
        \@@_if_in_setup:Nnn
          \l_@@_end_sentence_punct_clist
          { `#2 }
          \@@_set_current_punct_width_ratio_end:
      }
    #1
    #2
  }

\cs_new_protected:Npn \@@_if_in_setup:Nnn #1#2#3
  {
    \clist_map_inline:Nn #1
      {
        \int_compare:nNnT {##1} = {#2}
          { \clist_map_break:n {#3} }
      }
  }

\cs_new_protected:Npn \@@_set_current_punct_width_ratio:
  {
    \fp_set_eq:NN \l_@@_current_punct_width_ratio_fp
      \l_@@_punct_width_ratio_fp
  }

\cs_new_protected:Npn \@@_set_current_punct_width_ratio_end:
  {
    \fp_set_eq:NN \l_@@_current_punct_width_ratio_fp
      \l_@@_end_sentence_punct_width_ratio_fp
  }

% CJK 与 CJK

\XeTeXinterchartoks \g_@@_CJK_class \g_@@_CJK_class
  { \@@_insert_CJKglue: }

% CJK 与 closing

\XeTeXinterchartoks \g_@@_CJK_class \g_@@_Closing_LeftHalf_class
  {
    \@@_insert_nobreak_CJKglue:
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN
      {
        \bool_if:NT \l_@@_hang_current_punct_bool
          \tex_unskip:D
      }
  }

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \g_@@_CJK_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_hang_current_punct_bool
      {
        \@@_remove_blank_add_glue:n
          { \fp_use:N \l_@@_punct_min_width_ratio_fp em }
        \bool_if:NF \l_@@_keep_current_punct_blank_bool
          { \@@_allowbreak: }
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
              \l_@@_current_punct_width_ratio_fp
            - \l_@@_punct_min_width_ratio_fp
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
    \@@_insert_CJKglue:
  }

\XeTeXinterchartoks \g_@@_CJK_class \g_@@_Closing_MiddleHalf_class
  {
    \@@_insert_nobreak_CJKglue:
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN
      {
%        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \g_@@_CJK_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
            ( \l_@@_current_punct_width_ratio_fp
            - \l_@@_mid_punct_min_width_ratio_fp ) / 2
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
    \@@_insert_CJKglue:
  }

\XeTeXinterchartoks \g_@@_CJK_class \g_@@_Closing_Full_class
  { \@@_insert_nobreak_CJKglue: }

\XeTeXinterchartoks \g_@@_Closing_Full_class \g_@@_CJK_class
  { \@@_insert_CJKglue: }

% CJK 与 opening

\XeTeXinterchartoks \g_@@_CJK_class \g_@@_Opening_RightHalf_class
  {
    \@@_insert_CJKglue:
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
              \l_@@_punct_width_ratio_fp
            - \l_@@_punct_min_width_ratio_fp
          }
          \c_zero_fp em
      }
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \g_@@_CJK_class
  { \@@_insert_nobreak_CJKglue: }

\XeTeXinterchartoks \g_@@_CJK_class \g_@@_Opening_Full_class
  { \@@_insert_CJKglue: }

\XeTeXinterchartoks \g_@@_Opening_Full_class \g_@@_CJK_class
  { \@@_insert_nobreak_CJKglue: }

% closing 到 opening

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \g_@@_Opening_RightHalf_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_hang_current_punct_bool
      {
        \@@_remove_blank_add_glue:n
          { \fp_use:N \l_@@_punct_min_width_ratio_fp em }
        \bool_if:NF \l_@@_keep_current_punct_blank_bool
          { \@@_allowbreak: }
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
              \l_@@_current_punct_width_ratio_fp
            - \l_@@_punct_min_width_ratio_fp
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \g_@@_Opening_RightHalf_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
            ( \l_@@_current_punct_width_ratio_fp
            - \l_@@_mid_punct_min_width_ratio_fp ) / 2
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Closing_Full_class \g_@@_Opening_RightHalf_class
  {
    \@@_allowbreak:
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \g_@@_Opening_Full_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_hang_current_punct_bool
      {
        \@@_remove_blank_add_glue:n
          { \fp_use:N \l_@@_punct_min_width_ratio_fp em }
        \bool_if:NF \l_@@_keep_current_punct_blank_bool
          { \@@_allowbreak: }
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
              \l_@@_current_punct_width_ratio_fp
            - \l_@@_punct_min_width_ratio_fp
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \g_@@_Opening_Full_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
            ( \l_@@_current_punct_width_ratio_fp
            - \l_@@_mid_punct_min_width_ratio_fp ) / 2
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
  }

\XeTeXinterchartoks \g_@@_Closing_Full_class \g_@@_Opening_Full_class
  { \@@_allowbreak: }

% opening 到 opening

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \g_@@_Opening_RightHalf_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_kern_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Opening_Full_class \g_@@_Opening_RightHalf_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \g_@@_Opening_Full_class
  { }

\XeTeXinterchartoks \g_@@_Opening_Full_class \g_@@_Opening_Full_class
  { }

% closing 到 closing

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \g_@@_Closing_LeftHalf_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_kern_width_ratio_fp em }
    \@@_preprocess_closing_punct:nN { }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \g_@@_Closing_LeftHalf_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
    \@@_nobreak:
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
            ( \l_@@_current_punct_width_ratio_fp
            - \l_@@_mid_punct_min_width_ratio_fp ) / 2
          }
          \c_zero_fp em
      }
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN { }
  }

\XeTeXinterchartoks \g_@@_Closing_Full_class \g_@@_Closing_LeftHalf_class
  {
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN { }
  }

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \g_@@_Closing_MiddleHalf_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
    \@@_preprocess_closing_punct:nN
      {
        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \g_@@_Closing_MiddleHalf_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
    \@@_preprocess_closing_punct:nN
      {
        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Closing_Full_class \g_@@_Closing_MiddleHalf_class
  {
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN
      {
        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \g_@@_Closing_Full_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \g_@@_Closing_Full_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
    \@@_nobreak:
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
            ( \l_@@_current_punct_width_ratio_fp
            - \l_@@_mid_punct_min_width_ratio_fp ) / 2
          }
          \c_zero_fp em
      }
  }

\XeTeXinterchartoks \g_@@_Closing_Full_class \g_@@_Closing_Full_class
  { }

% opening 到 closing

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \g_@@_Closing_LeftHalf_class
  {
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN { }
  }

\XeTeXinterchartoks \g_@@_Opening_Full_class \g_@@_Closing_LeftHalf_class
  {
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN { }
  }

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \g_@@_Closing_MiddleHalf_class
  {
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN
      {
        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Opening_Full_class \g_@@_Closing_MiddleHalf_class
  {
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN
      {
        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \g_@@_Closing_Full_class
  { }

\XeTeXinterchartoks \g_@@_Opening_Full_class \g_@@_Closing_Full_class
  { }

% 消除 boundary 到 CJK 插入的 tokens

\cs_new_protected:Npn \@@_clear_Boundary_to_CJK_interchartoks:
  {
    \clist_map_inline:nn
      {
        \g_@@_CJK_class ,
        \g_@@_Closing_LeftHalf_class ,
        \g_@@_Closing_MiddleHalf_class ,
        \g_@@_Closing_Full_class ,
        \g_@@_Opening_RightHalf_class ,
        \g_@@_Opening_Full_class
      }
      {
        \tex_XeTeXinterchartoks:D
          \e@alloc@intercharclass@top ##1 { }
      }
  }

% class 0

\XeTeXinterchartoks \c_zero_int \g_@@_CJK_class
  {
    \@@_insert_CJKecglue:
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_CJK_class \c_zero_int
  {
    \c_group_end_token
    \@@_insert_CJKecglue:
  }

\XeTeXinterchartoks \c_zero_int \g_@@_Closing_LeftHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN { }
  }

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \c_zero_int
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_hang_current_punct_bool
      {
        \@@_remove_blank_add_glue:n
          { \fp_use:N \l_@@_punct_min_width_ratio_fp em }
        \bool_if:NF \l_@@_keep_current_punct_blank_bool
          { \@@_allowbreak: }
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
              \l_@@_current_punct_width_ratio_fp
            - \l_@@_punct_min_width_ratio_fp
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
    \c_group_end_token
    \skip_horizontal:N \c_zero_skip
  }

\XeTeXinterchartoks \c_zero_int \g_@@_Closing_MiddleHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN
      {
        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \c_zero_int
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
            ( \l_@@_current_punct_width_ratio_fp
            - \l_@@_mid_punct_min_width_ratio_fp ) / 2
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
    \c_group_end_token
    \skip_horizontal:N \c_zero_skip
  }

\XeTeXinterchartoks \c_zero_int \g_@@_Closing_Full_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_Closing_Full_class \c_zero_int
  {
    \c_group_end_token
    \skip_horizontal:N \c_zero_skip
  }

\XeTeXinterchartoks \c_zero_int \g_@@_Opening_RightHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
              \l_@@_punct_width_ratio_fp
            - \l_@@_punct_min_width_ratio_fp
          }
          \c_zero_fp em
      }
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \c_zero_int
  {
    \c_group_end_token
    \@@_nobreak: \skip_horizontal:N \c_zero_skip
  }

\XeTeXinterchartoks \c_zero_int \g_@@_Opening_Full_class
  {
    \@@_allowbreak:
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_Opening_Full_class \c_zero_int
  {
    \c_group_end_token
    \@@_nobreak: \skip_horizontal:N \c_zero_skip
  }

% class non-CJK punctuation

\XeTeXinterchartoks \g_@@_non_CJK_Punct_class \g_@@_CJK_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_CJK_class \g_@@_non_CJK_Punct_class
  {
    \c_group_end_token
  }

\XeTeXinterchartoks \g_@@_non_CJK_Punct_class \g_@@_Closing_LeftHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN { }
  }

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \g_@@_non_CJK_Punct_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_hang_current_punct_bool
      {
        \@@_remove_blank_add_glue:n
          { \fp_use:N \l_@@_punct_min_width_ratio_fp em }
        \bool_if:NF \l_@@_keep_current_punct_blank_bool
          { \@@_allowbreak: }
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
              \l_@@_current_punct_width_ratio_fp
            - \l_@@_punct_min_width_ratio_fp
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
    \c_group_end_token
    \skip_horizontal:N \c_zero_skip
  }

\XeTeXinterchartoks \g_@@_non_CJK_Punct_class \g_@@_Closing_MiddleHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN
      {
        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \g_@@_non_CJK_Punct_class
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_nobreak: }
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
            ( \l_@@_current_punct_width_ratio_fp
            - \l_@@_mid_punct_min_width_ratio_fp ) / 2
          }
          \c_zero_fp em
      }
    \bool_if:NT \l_@@_keep_current_punct_blank_bool
      { \@@_allowbreak: }
    \c_group_end_token
    \skip_horizontal:N \c_zero_skip
  }

\XeTeXinterchartoks \g_@@_non_CJK_Punct_class \g_@@_Closing_Full_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_Closing_Full_class \g_@@_non_CJK_Punct_class
  {
    \c_group_end_token
    \skip_horizontal:N \c_zero_skip
  }

\XeTeXinterchartoks \g_@@_non_CJK_Punct_class \g_@@_Opening_RightHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \exp_args:Nx \@@_add_shrinkable_glue:n
      {
        \fp_max:nn
          {
              \l_@@_punct_width_ratio_fp
            - \l_@@_punct_min_width_ratio_fp
          }
          \c_zero_fp em
      }
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \g_@@_non_CJK_Punct_class
  {
    \c_group_end_token
    \@@_nobreak: \skip_horizontal:N \c_zero_skip
  }

\XeTeXinterchartoks \g_@@_non_CJK_Punct_class \g_@@_Opening_Full_class
  {
    \@@_allowbreak:
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_Opening_Full_class \g_@@_non_CJK_Punct_class
  {
    \c_group_end_token
    \@@_nobreak: \skip_horizontal:N \c_zero_skip
  }

% class boundary

\XeTeXinterchartoks \e@alloc@intercharclass@top \g_@@_CJK_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_CJK_class \e@alloc@intercharclass@top
  {
    \c_group_end_token
  }

\XeTeXinterchartoks \e@alloc@intercharclass@top \g_@@_Closing_LeftHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN { }
  }

\XeTeXinterchartoks \g_@@_Closing_LeftHalf_class \e@alloc@intercharclass@top
  {
    \c_group_end_token
  }

\XeTeXinterchartoks \e@alloc@intercharclass@top \g_@@_Closing_MiddleHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \@@_set_current_punct_width_ratio:
    \@@_preprocess_closing_punct:nN
      {
        \@@_nobreak:
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                ( \l_@@_current_punct_width_ratio_fp
                - \l_@@_mid_punct_min_width_ratio_fp ) / 2
              }
              \c_zero_fp em
          }
        \@@_remove_blank:n
          { \fp_use:N \l_@@_mid_punct_removable_width_ratio_fp em }
      }
  }

\XeTeXinterchartoks \g_@@_Closing_MiddleHalf_class \e@alloc@intercharclass@top
  {
    \c_group_end_token
  }

\XeTeXinterchartoks \e@alloc@intercharclass@top \g_@@_Closing_Full_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_Closing_Full_class \e@alloc@intercharclass@top
  {
    \c_group_end_token
  }

\XeTeXinterchartoks \e@alloc@intercharclass@top \g_@@_Opening_RightHalf_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
    \group_begin: \exp_args:Nc \group_end:
      {
        @@_Boundary_
        \int_use:N \tex_lastnodetype:D
        _to_Opening_RightHalf:
      }
  }

\XeTeXinterchartoks \g_@@_Opening_RightHalf_class \e@alloc@intercharclass@top
  {
    \c_group_end_token
  }

\XeTeXinterchartoks \e@alloc@intercharclass@top \g_@@_Opening_Full_class
  {
    \c_group_begin_token
    \l_@@_CJK_fontfamily_tl
    \@@_clear_Boundary_to_CJK_interchartoks:
  }

\XeTeXinterchartoks \g_@@_Opening_Full_class \e@alloc@intercharclass@top
  {
    \c_group_end_token
  }

% empty list
\cs_new_protected:cpn { @@_Boundary_-1_to_Opening_RightHalf: }
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

% hlist node
\box_new:N \l_@@_tmp_box
\cs_new_protected:cpn { @@_Boundary_ 1_to_Opening_RightHalf: }
  {
    \box_set_to_last:N \l_@@_tmp_box
    \int_compare:nNnTF \tex_lastnodetype:D = { -1 }
      {
        \dim_compare:nNnTF
          { \box_wd:N \l_@@_tmp_box } = \tex_parindent:D
          {
            \dim_compare:nNnTF
              { \box_ht:N \l_@@_tmp_box } = \c_zero_dim
              {
                \dim_compare:nNnTF
                  { \box_dp:N \l_@@_tmp_box } = \c_zero_dim
                  { \use_i:nn }
                  { \use:nn }
              }
              { \use:nn }
          }
          { \use:nn }
      }
      { \use:nn }
      { \box_use_drop:N \l_@@_tmp_box }
      {
        \exp_args:Nx \@@_add_shrinkable_glue:n
          {
            \fp_max:nn
              {
                  \l_@@_punct_width_ratio_fp
                - \l_@@_punct_min_width_ratio_fp
              }
              \c_zero_fp em
          }
      }
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

% rule node
\cs_new_protected:cpn { @@_Boundary_ 3_to_Opening_RightHalf: }
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

% glue node
\cs_new_protected:cpn { @@_Boundary_11_to_Opening_RightHalf: }
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

% kern node
\cs_new_protected:cpn { @@_Boundary_12_to_Opening_RightHalf: }
  {
    \@@_remove_blank:n
      { \fp_use:N \l_@@_punct_removable_width_ratio_fp em }
  }

% 字符分类

\cs_new_protected:Npn \@@_assign_charclass_to_charcode:Nn #1#2
  {
    \clist_map_inline:nn {#2}
      { \@@_assign_charclass_to_charcode_aux:Nw #1##1 - - \q_stop }
  }

\msg_new:nnnn { newxeCJK } { invalid-range }
  { The~start~index~(#1)~is~greater~than~the~end~index~(#2). }
  {
    A~valid~range~should~have~its~start~index~
    less~than~or~equal~to~its~end~index.
  }
\cs_new_protected:Npn \@@_assign_charclass_to_charcode_aux:Nw
  #1#2 - #3 - #4 \q_stop
  {
    \int_set:Nn \l_tmpa_int {#2}
    \tl_if_empty:nTF {#3}
      { \tex_XeTeXcharclass:D \l_tmpa_int = #1 }
      {
        \int_compare:nNnTF \l_tmpa_int > {#3}
          {
            \msg_error:nnnn { newxeCJK } { invalid-range } {#2} {#3}
          }
          {
            \int_do_until:nNnn \l_tmpa_int > {#3}
              {
                \tex_XeTeXcharclass:D \l_tmpa_int = #1
                \int_incr:N \l_tmpa_int
              }
          }
      }
  }

\@@_assign_charclass_to_charcode:Nn \g_@@_CJK_class
  {
% Spacing Modifier Letters (only U+02EA and U+02EB)
%    "02C9 , "02CA , "02C7 , "02CB , "02D9 ,
    "02EA - "02EB ,
% Hangul Jamo
    "1100 - "11FF ,
% Miscellaneous Technical (only U+23DA and U+23DB)
    "23DA - "23DB ,
% Enclosed Alphanumerics
    "2460 - "24FF ,
% Miscellaneous Symbols (U+2616..U+2617, U+2630..U+2637, U+268A..U+268F)
    "2616 - "2617 ,
    "2630 - "2637 ,
    "268A - "268F ,
% Dingbats (only U+2776 through U+2793)
    "2776 - "2793 ,
% CJK Radicals Supplement
    "2E80 - "2EFF ,
% Kangxi Radicals
    "2F00 - "2FDF ,
% Ideographic Description Characters
    "2FF0 - "2FFF ,
% CJK Symbols and Punctuation
    "3000 - "303F ,
% Hiragana (U+3099 and U+309A are combining marks)
    "3040 - "309F ,
% Katakana
    "30A0 - "30FF ,
% Bopomofo
    "3100 - "312F ,
% Hangul Compatibility Jamo
    "3130 - "318F ,
% Kanbun
    "3190 - "319F ,
% Bopomofo Extended
    "31A0 - "31BF ,
% CJK Strokes
    "31C0 - "31EF ,
% Katakana Phonetic Extensions
    "31F0 - "31FF ,
% Enclosed CJK Letters and Months
    "3200 - "32FF ,
% CJK Compatibility
    "3300 - "33FF ,
% CJK Unified Ideographs Extension A
    "3400 - "4DBF ,
% Yijing Hexagram Symbols
    "4DC0 - "4DFF ,
% CJK Unified Ideographs
    "4E00 - "9FFF ,
% Yi Syllables
    "A000 - "A48F ,
% Yi Radicals
    "A490 - "A4CF ,
% Lisu
%    "A4D0 - "A4FF ,
% Modifier Tone Letters
    "A700 - "A71F ,
% Hangul Jamo Extended-A
    "A960 - "A97F ,
% Hangul Syllables
    "AC00 - "D7AF ,
% Hangul Jamo Extended-B
    "D7B0 - "D7FF ,
% CJK Compatibility Ideographs
    "F900 - "FAFF ,
% Vertical Forms
    "FE10 - "FE1F ,
% CJK Compatibility Forms
    "FE30 - "FE4F ,
% Small Form Variants
    "FE50 - "FE6F ,
% Halfwidth and Fullwidth Forms
    "FF00 - "FFEF ,
% Lisu Supplement
%    "11FB0 - "11FBF ,
% Miao
%    "16F00 - "16F9F ,
% Ideographic Symbols and Punctuation
    "16FE0 - "16FFF ,
% Tangut
    "17000 - "187FF ,
% Tangut Components
    "18800 - "18AFF ,
% Khitan Small Script
    "18B00 - "18CFF ,
% Tangut Supplement
    "18D00 - "18D8F ,
% Kana Supplement
    "1B000 - "1B0FF ,
% Kana Extended-A
    "1B100 - "1B12F ,
% Small Kana Extension
    "1B130 - "1B16F ,
% Nushu
    "1B170 - "1B2FF ,
% Tai Xuan Jing Symbols
    "1D300 - "1D35F ,
% Counting Rod Numerals (only U+1D360 through U+1D376)
    "1D360 - "1D376 ,
% Mahjong Tiles
    "1F000 - "1F02F ,
% Enclosed Alphanumeric Supplement
    "1F100 - "1F1FF ,
% Enclosed Ideographic Supplement
    "1F200 - "1F2FF ,
% Chess Symbols (only U+1FA60 through U+1FA6D)
    "1FA60 - "1FA6D ,
% CJK Unified Ideographs Extension B
    "20000 - "2A6DF ,
% CJK Unified Ideographs Extension C
    "2A700 - "2B73F ,
% CJK Unified Ideographs Extension D
    "2B740 - "2B81F ,
% CJK Unified Ideographs Extension E
    "2B820 - "2CEAF ,
% CJK Unified Ideographs Extension F
    "2CEB0 - "2EBEF ,
% CJK Compatibility Ideographs Supplement
    "2F800 - "2FA1F ,
% CJK Unified Ideographs Extension G
    "30000 - "3134F
  }

\@@_assign_charclass_to_charcode:Nn \g_@@_non_CJK_Punct_class
  {
    "21 - "2F ,
    "3A - "40 ,
    "5B - "60 ,
    "7B - "7E
  }

\clist_set:Nn \l_@@_end_sentence_punct_clist
  {
    "3002 , "FF01 , "FF0E , "FF1F , "FE12
  }

\clist_set:Nn \l_@@_hangable_punct_clist
  {
    "3001 , "3002 , "FF0C , "FF0E ,
    "FE10 , "FE11 , "FE12
  }

\cs_new_protected:Npn \ChineseSimplifiedH
  {
    \clist_clear:N \l_@@_keep_blank_punct_clist
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_LeftHalf_class
      {
% 简体中文与英文共用的引号
        "2019 , "201D ,
% 简体中文横排
        "3001 , "3002 , "FF01 , "FF0C , "FF0E ,
        "FF1A , "FF1B , "FF1F ,
% 通用横排
        "3009 , "300B , "300D , "300F , "3011 ,
        "3015 , "3017 , "3019 , "301B , "301E ,
        "301F , "FF09 , "FF3D , "FF5D , "FF60 ,
% 简体中文直排
        "FE10 , "FE11 , "FE12 ,
% 通用直排
        "FE18 , "FE36 , "FE38 , "FE3A , "FE3C ,
        "FE3E , "FE40 , "FE42 , "FE44 , "FE48 ,
% 日文音调符号，不允许出现在行首
        "309B , "309C
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_MiddleHalf_class
      {
% 港台间隔号
        "2027 ,
% 日文间隔号
        "30A0 , "30FB ,
% 不太确定
        "FF5C , "FFE4 ,
%        "FF02 , "FF07 , "FF3E , "FF40 ,
% 直排 En Dash
        "FE32
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_Full_class
      {
% 中西共用的标点
        "2014 , "2015 , "2025 , "2026 ,
% 通用横排
        "301C , "3030 , "FF05 , "FF5E , "FFE0 ,
% 数学符号
        "FF0A , "FF0B , "FF0D , "FF0F ,
        "FF1C , "FF1D , "FF1E , "FF3C ,
% 简体、繁体中文直排，日文的会旋转成水平的
        "FE13 ,
% 通用直排
        "FE14 , "FE15 , "FE16 , "FE19 , "FE30 ,
        "FE31 ,
% Small Form Variants
        "FE50 , "FE51 , "FE52 , "FE54 , "FE55 ,
        "FE56 , "FE57 , "FE58 , "FE5A , "FE5C ,
        "FE5E , "FE61 , "FE62 , "FE63 , "FE64 ,
        "FE65 , "FE66 , "FE68 , "FE6A ,
% 叠字符号、日文长音符，不允许出现在行首
        "3005 , "3031 , "3032 , "3033 , "3034 ,
        "3035 , "303B , "309D , "309E , "30FC ,
        "30FD , "30FE ,
% 日文小平假名
        "3041 , "3043 , "3045 , "3047 , "3049 ,
        "3063 , "3083 , "3085 , "3087 , "308E ,
        "3095 , "3096 ,
% 日文小片假名
        "30A1 , "30A3 , "30A5 , "30A7 , "30A9 ,
        "30C3 , "30E3 , "30E5 , "30E7 , "30EE ,
        "30F5 , "30F6 ,
% 日文小片假名扩展
        "31F0 - "31FF ,
% 变宽或半宽的标点，原则上是居中占满的，所以两端不做挤压调整
% 中西共用的标点
        "00B7 , "2013 , "2E3A , "2E3B ,
% 半宽标点
        "FF61 , "FF63 , "FF64 , "FF65 , "FFE8 ,
% 半宽日文音调符号，不允许出现在行首
        "FF70 , "FF9E , "FF9F
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Opening_RightHalf_class
      {
% 简体中文与英文共用的引号
        "2018 , "201C ,
% 通用横排
        "3008 , "300A , "300C , "300E , "3010 ,
        "3014 , "3016 , "3018 , "301A , "301D ,
        "FF08 , "FF3B , "FF5B , "FF5F ,
% 通用直排
        "FE17 , "FE35 , "FE37 , "FE39 , "FE3B ,
        "FE3D , "FE3F , "FE41 , "FE43 , "FE47
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Opening_Full_class
      {
        "FF03 , "FF04 , "FFE1 , "FFE5 , "FFE6 ,
% Small Form Variants
        "FE59 , "FE5B , "FE5D , "FE5F , "FE69 ,
% 日文邮编/邮局记号、日文庵点，不允许出现在行末
        "3012 , "3020 , "3036 , "303D ,
% 半宽标点
        "FF62
      }
  }
\ChineseSimplifiedH

\cs_new_protected:Npn \ChineseSimplifiedV
  {
    \ChineseSimplifiedH
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_Full_class
      {
        "FF01 , "FF1A , "FF1B , "FF1F
      }
  }

% 繁体中文/日文的这些标点可以来自英文字体
\cs_new_protected:Npn \@@_assign_non_CJK_Punct_class:
  {
    \@@_assign_charclass_to_charcode:Nn \g_@@_non_CJK_Punct_class
      {
        "2019 , "201D ,
        "00B7 ,
        "2018 , "201C
      }
  }

\cs_new_protected:Npn \ChineseTraditionalH
  {
    \ChineseSimplifiedH
    \clist_set:Nn \l_@@_keep_blank_punct_clist
      {
        "2027 ,
        "3001 , "3002 , "FF01 , "FF0C , "FF0E ,
        "FF1A , "FF1B ,
        "FE10 , "FE11 , "FE12
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_MiddleHalf_class
      {
        "3001 , "3002 , "FF01 , "FF0C , "FF0E ,
        "FF1A , "FF1B ,
        "FE10 , "FE11 , "FE12
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_Full_class
      {
        "FF1F
      }
    \@@_assign_non_CJK_Punct_class:
  }

\cs_new_protected:Npn \ChineseTraditionalV
  {
    \ChineseSimplifiedH
    \clist_set:Nn \l_@@_keep_blank_punct_clist
      {
        "2027 ,
        "3001 , "3002 , "FF0C , "FF0E ,
        "FE10 , "FE11 , "FE12
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_MiddleHalf_class
      {
        "3001 , "3002 , "FF0C , "FF0E ,
        "FE10 , "FE11 , "FE12
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_Full_class
      {
        "FF01 , "FF1A , "FF1B , "FF1F
      }
    \@@_assign_non_CJK_Punct_class:
  }

\cs_new_protected:Npn \JapaneseH
  {
    \ChineseSimplifiedH
    \clist_set:Nn \l_@@_keep_blank_punct_clist
      {
        "3002 , "FF0E , "FE12
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_MiddleHalf_class
      {
        "FF1A , "FF1B
      }
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_Full_class
      {
        "FF01 , "FF1F
      }
    \@@_assign_non_CJK_Punct_class:
  }

\cs_new_protected:Npn \JapaneseV
  {
    \JapaneseH
    \@@_assign_charclass_to_charcode:Nn \g_@@_Closing_Full_class
      {
        "FF1B
      }
  }

% Turning on the inter-char token mechanism. Enjoy!

\tex_XeTeXinterchartokenstate:D \c_one_int

\ExplSyntaxOff
\makeatother